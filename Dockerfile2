# 用依赖齐全的基础镜像
FROM python:3.11

# 设置工作目录
WORKDIR /app

# 安装系统依赖（opencv 和 mediapipe 需要）
RUN apt-get update && apt-get install -y \
    libgl1-mesa-glx \
    libglib2.0-0 \
    libegl1 \
    && rm -rf /var/lib/apt/lists/*

# 配置 pip 国内源
# RUN mkdir -p /root/.pip && \
#     echo "[global]\nindex-url = https://pypi.tuna.tsinghua.edu.cn/simple" > /root/.pip/pip.conf
RUN mkdir -p /root/.pip && \
    echo "[global]\nindex-url = https://pypi.tuna.tsinghua.edu.cn/simple" > /root/.pip/pip.conf

# 先复制 requirements.txt
COPY requirements.txt .

# 安装依赖，强制只用 wheel，防止慢到爆的编译
RUN pip install --only-binary=:all: --no-cache-dir -r requirements.txt || \
    (echo "⚠️ 部分包没有 wheel，尝试普通安装" && pip install --no-cache-dir -r requirements.txt)

# 再复制项目文件
COPY . .

# 启动命令
CMD ["python", "app.py"]
